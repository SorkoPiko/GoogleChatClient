#!/bin/bash

# Don't exit on failure - try to complete as much as possible
set +e

echo "Running postinstall script..."

# Get current console user more reliably
CURRENT_USER=$(/usr/bin/stat -f '%Su' /dev/console)
USER_HOME=$(dscl . -read /Users/"$CURRENT_USER" NFSHomeDirectory | sed 's/NFSHomeDirectory: //')

# Create a log file in user's home directory where we have write permissions
LOG_FILE="$USER_HOME/Library/Logs/google-chat-install.log"
mkdir -p "$USER_HOME/Library/Logs"
touch "$LOG_FILE" 2>/dev/null || LOG_FILE="/tmp/google-chat-install-${RANDOM}.log"

echo "Starting installation $(date)" > "$LOG_FILE"
echo "Detected user: $CURRENT_USER with home: $USER_HOME" | tee -a "$LOG_FILE"

# Check where the app might be installed
echo "Checking installation directories:" | tee -a "$LOG_FILE"

# User's Applications folder should be accessible without admin rights
USER_APP_PATH="$USER_HOME/Applications/Google Chat.app"

# Debug the path
echo "Looking for app at: $USER_APP_PATH" | tee -a "$LOG_FILE"
if [ -d "$USER_APP_PATH" ]; then
    echo "App found at user Applications folder" | tee -a "$LOG_FILE"
    ls -la "$USER_APP_PATH" >> "$LOG_FILE" 2>&1
    
    # Try to remove quarantine attributes (should work without admin)
    echo "Removing quarantine attributes..." | tee -a "$LOG_FILE"
    xattr -d com.apple.quarantine "$USER_APP_PATH" >> "$LOG_FILE" 2>&1 || echo "Failed to remove quarantine attribute, may not be needed" | tee -a "$LOG_FILE"
    
    # Verify the app is executable by the user
    echo "Checking execute permissions..." | tee -a "$LOG_FILE"
    if [ -x "$USER_APP_PATH/Contents/MacOS/Google Chat" ]; then
        echo "App is executable" | tee -a "$LOG_FILE"
    else
        echo "Warning: App may not be executable" | tee -a "$LOG_FILE"
    fi
else
    echo "Warning: App not found at $USER_APP_PATH" | tee -a "$LOG_FILE"
    # Check if it's in system Applications by any chance
    if [ -d "/Applications/Google Chat.app" ]; then
        echo "App found in system Applications folder, but we don't have admin rights to modify it" | tee -a "$LOG_FILE"
    fi
fi

echo "Postinstall completed" | tee -a "$LOG_FILE"
echo "See $LOG_FILE for installation details" | tee -a "$LOG_FILE"

# Always exit successfully so the installer completes
exit 0