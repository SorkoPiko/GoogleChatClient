#!/bin/bash

# Don't exit on failure - try to complete as much as possible
set +e

echo "Running postinstall script..."

# Get current console user more reliably
CURRENT_USER=$(/usr/bin/stat -f '%Su' /dev/console)
USER_HOME=$(dscl . -read /Users/"$CURRENT_USER" NFSHomeDirectory | sed 's/NFSHomeDirectory: //')

# Create a log file in a location that should be writable
LOG_FILE="/tmp/google-chat-install.log"
echo "Starting installation $(date)" > "$USER_HOME/$LOG_FILE"

echo "Detected user: $CURRENT_USER with home: $USER_HOME" | tee -a "$LOG_FILE"

# List common directories to help diagnose
echo "Checking installation directories:" | tee -a "$LOG_FILE"
ls -la /Applications/ >> "$LOG_FILE" 2>&1
echo "User Applications:" | tee -a "$LOG_FILE"
mkdir -p "$USER_HOME/Applications"
ls -la "$USER_HOME/Applications/" >> "$LOG_FILE" 2>&1

# Define app paths - check both potential installation locations
SYSTEM_APP_PATH="/Applications/Google Chat.app"
USER_APP_PATH="$USER_HOME/Applications/Google Chat.app" 

# Now check where the app was actually installed
if [ -d "$SYSTEM_APP_PATH" ]; then
    APP_PATH="$SYSTEM_APP_PATH"
    echo "App found at system Applications folder" | tee -a "$LOG_FILE"
elif [ -d "$USER_APP_PATH" ]; then
    APP_PATH="$USER_APP_PATH"
    echo "App found at user Applications folder" | tee -a "$LOG_FILE"
else
    echo "Warning: App not found in expected locations" | tee -a "$LOG_FILE"
    # Don't exit with error - continue so the installer completes
fi

# Whether or not we found the app, try to perform cleanup operations
for POSSIBLE_APP in "$SYSTEM_APP_PATH" "$USER_APP_PATH"; do
    if [ -d "$POSSIBLE_APP" ]; then
        echo "Found app at $POSSIBLE_APP - attempting cleanup" | tee -a "$LOG_FILE"
        
        # Try to remove quarantine attributes
        echo "Removing quarantine attributes..." | tee -a "$LOG_FILE"
        xattr -cr "$POSSIBLE_APP" >> "$LOG_FILE" 2>&1
        
        # Try to set proper ownership and permissions
        echo "Setting proper permissions..." | tee -a "$LOG_FILE"
        chown -R "$CURRENT_USER" "$POSSIBLE_APP" >> "$LOG_FILE" 2>&1
        chmod -R 755 "$POSSIBLE_APP" >> "$LOG_FILE" 2>&1
    fi
done

echo "Postinstall completed successfully" | tee -a "$LOG_FILE"
echo "See $LOG_FILE for installation details" | tee -a "$LOG_FILE"

# Always exit successfully so the installer completes
exit 0