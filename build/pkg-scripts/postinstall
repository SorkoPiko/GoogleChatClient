#!/bin/bash

# Make script exit if any command fails
set -e

echo "Running postinstall script..."

# Get current console user more reliably
CURRENT_USER=$(/usr/bin/stat -f '%Su' /dev/console)
USER_HOME=$(dscl . -read /Users/"$CURRENT_USER" NFSHomeDirectory | sed 's/NFSHomeDirectory: //')

echo "Detected user: $CURRENT_USER with home: $USER_HOME"

# Define app paths - check both potential installation locations
SYSTEM_APP_PATH="/Applications/Google Chat.app"
USER_APP_PATH="$USER_HOME/Applications/Google Chat.app" 

# Now check where the app was actually installed
if [ -d "$SYSTEM_APP_PATH" ]; then
    APP_PATH="$SYSTEM_APP_PATH"
    echo "App found at system Applications folder"
elif [ -d "$USER_APP_PATH" ]; then
    APP_PATH="$USER_APP_PATH"
    echo "App found at user Applications folder"
else
    echo "Error: App not found in either Applications location"
    exit 1
fi

# Remove quarantine attributes
echo "Removing quarantine attributes..."
xattr -rc "$APP_PATH" || true

# Set proper ownership and permissions
echo "Setting proper permissions..."
chown -R "$CURRENT_USER" "$APP_PATH"
chmod -R 755 "$APP_PATH"

echo "Postinstall completed successfully"
exit 0