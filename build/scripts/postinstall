#!/bin/bash

# Get current user
CURRENT_USER=$(stat -f "%Su" /dev/console)
USER_HOME=$(dscl . -read /Users/$CURRENT_USER NFSHomeDirectory | sed 's/^NFSHomeDirectory: //')

# Define app paths
TEMP_APP_PATH="/Applications/Google Chat.app"
USER_APPLICATIONS="$USER_HOME/Applications"
FINAL_APP_PATH="$USER_APPLICATIONS/Google Chat.app"

# Make sure the user's Applications folder exists
mkdir -p "$USER_APPLICATIONS"

# If the app was installed to /Applications, move it to ~/Applications
if [ -d "$TEMP_APP_PATH" ]; then
    echo "Moving app to user's Applications folder..."
    cp -R "$TEMP_APP_PATH" "$USER_APPLICATIONS/"
    rm -rf "$TEMP_APP_PATH"
fi

# Remove quarantine attributes
echo "Removing quarantine attributes..."
/usr/bin/xattr -cr "$FINAL_APP_PATH"

# Set proper ownership and permissions
echo "Setting proper permissions..."
chown -R $CURRENT_USER "$FINAL_APP_PATH"
chmod -R 755 "$FINAL_APP_PATH"

# Launch the app
echo "Launching Google Chat..."
sudo -u $CURRENT_USER open "$FINAL_APP_PATH"

exit 0